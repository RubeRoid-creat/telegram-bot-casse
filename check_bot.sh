#!/bin/bash
# –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –±–æ—Ç–∞

cd "$(dirname "$0")"

echo "üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –±–æ—Ç–∞..."
echo ""

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–π–ª–∞ .env
echo "1Ô∏è‚É£  –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–π–ª–∞ .env:"
if [ -f ".env" ]; then
    echo "   ‚úÖ –§–∞–π–ª .env —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
    if grep -q "BOT_TOKEN=" .env; then
        TOKEN_LENGTH=$(grep "BOT_TOKEN=" .env | cut -d'=' -f2 | wc -c)
        if [ $TOKEN_LENGTH -gt 10 ]; then
            echo "   ‚úÖ –¢–æ–∫–µ–Ω –Ω–∞–π–¥–µ–Ω (–¥–ª–∏–Ω–∞: $((TOKEN_LENGTH-1)) —Å–∏–º–≤–æ–ª–æ–≤)"
        else
            echo "   ‚ö†Ô∏è  –¢–æ–∫–µ–Ω —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π –∏–ª–∏ –ø—É—Å—Ç–æ–π"
        fi
    else
        echo "   ‚ùå BOT_TOKEN –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ .env"
    fi
else
    echo "   ‚ùå –§–∞–π–ª .env –Ω–µ –Ω–∞–π–¥–µ–Ω!"
fi
echo ""

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ—Ü–µ—Å—Å–∞
echo "2Ô∏è‚É£  –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ—Ü–µ—Å—Å–∞ –±–æ—Ç–∞:"
if [ -f "bot.pid" ]; then
    PID=$(cat bot.pid)
    if ps -p $PID > /dev/null 2>&1; then
        echo "   ‚úÖ –ë–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç (PID: $PID)"
    else
        echo "   ‚ùå –ü—Ä–æ—Ü–µ—Å—Å –Ω–µ –Ω–∞–π–¥–µ–Ω (PID: $PID)"
        echo "   ‚ö†Ô∏è  –§–∞–π–ª bot.pid —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –Ω–æ –ø—Ä–æ—Ü–µ—Å—Å –Ω–µ –∑–∞–ø—É—â–µ–Ω"
    fi
else
    echo "   ‚ùå –ë–æ—Ç –Ω–µ –∑–∞–ø—É—â–µ–Ω (—Ñ–∞–π–ª bot.pid –Ω–µ –Ω–∞–π–¥–µ–Ω)"
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ pkill
    if pgrep -f "python3 main.py" > /dev/null; then
        echo "   ‚ö†Ô∏è  –ù–∞–π–¥–µ–Ω –ø—Ä–æ—Ü–µ—Å—Å python3 main.py, –Ω–æ bot.pid –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç"
        pgrep -f "python3 main.py"
    fi
fi
echo ""

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤
echo "3Ô∏è‚É£  –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤:"
if [ -f "logs/bot.log" ]; then
    echo "   ‚úÖ –§–∞–π–ª –ª–æ–≥–æ–≤ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
    echo "   üìã –ü–æ—Å–ª–µ–¥–Ω–∏–µ 10 —Å—Ç—Ä–æ–∫ –ª–æ–≥–∞:"
    echo "   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
    tail -n 10 logs/bot.log | sed 's/^/   /'
    echo "   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –æ—à–∏–±–∫–∏
    if grep -i "error\|exception\|traceback" logs/bot.log | tail -1 > /dev/null; then
        echo "   ‚ö†Ô∏è  –ù–∞–π–¥–µ–Ω—ã –æ—à–∏–±–∫–∏ –≤ –ª–æ–≥–∞—Ö:"
        grep -i "error\|exception\|traceback" logs/bot.log | tail -3 | sed 's/^/   /'
    fi
else
    echo "   ‚ö†Ô∏è  –§–∞–π–ª –ª–æ–≥–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω"
fi
echo ""

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è
echo "4Ô∏è‚É£  –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è:"
if [ -f "venv/bin/activate" ]; then
    echo "   ‚úÖ –í–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ –Ω–∞–π–¥–µ–Ω–æ"
    source venv/bin/activate
    if python3 -c "import aiogram" 2>/dev/null; then
        echo "   ‚úÖ –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ aiogram —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞"
    else
        echo "   ‚ùå –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ aiogram –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞"
    fi
    deactivate
else
    echo "   ‚ö†Ô∏è  –í–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ"
fi
echo ""

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
echo "5Ô∏è‚É£  –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö:"
if [ -f "casse.db" ]; then
    echo "   ‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
    DB_SIZE=$(du -h casse.db | cut -f1)
    echo "   üìä –†–∞–∑–º–µ—Ä: $DB_SIZE"
else
    echo "   ‚ö†Ô∏è  –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ (–±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω–∞ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ)"
fi
echo ""

echo "‚úÖ –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"
echo ""
echo "üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:"
if [ ! -f ".env" ] || ! grep -q "BOT_TOKEN=" .env; then
    echo "   ‚Ä¢ –°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª .env —Å BOT_TOKEN=–≤–∞—à_—Ç–æ–∫–µ–Ω"
fi
if [ ! -f "bot.pid" ] || ! ps -p $(cat bot.pid 2>/dev/null) > /dev/null 2>&1; then
    echo "   ‚Ä¢ –ó–∞–ø—É—Å—Ç–∏—Ç–µ –±–æ—Ç–∞: ./start.sh"
fi
if [ -f "logs/bot.log" ] && grep -qi "error\|exception" logs/bot.log; then
    echo "   ‚Ä¢ –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –æ—à–∏–±–æ–∫: tail -f logs/bot.log"
fi

